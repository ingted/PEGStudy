<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>パーザコンビネータをつくろう</title>
    <meta name="description" content="パーザンコビネータをつくる">
    <meta name="author" content="pocketberserker">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="//code.jquery.com/jquery-1.8.0.js"></script>
    <script src="//code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/sky.css" id="theme">
    <link type="text/css" rel="stylesheet" href="fsharp.formatting/styles/style.css" />
    <link type="text/css" rel="stylesheet" href="fsharp.formatting/styles/deedle.css" />
    <link type="text/css" rel="stylesheet" href="css/custom.css" />
    <script src="fsharp.formatting/styles/tips.js" type="text/javascript"></script>
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">
    <link rel="stylesheet" href="css/fsreveal.css">
    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
    </script>
    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
    <script language="javascript" type="text/javascript">
        function init()
        {
            websocket = new WebSocket("ws://localhost:8083/websocket");
            websocket.onmessage = function(evt) { location.reload(); };
        }
        window.addEventListener("load", init, false);
    </script>
</head>
<body>
    <div class="reveal">
        <div class="tip" id="fs1">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs2">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs3">type &#39;T option = Option&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.option&lt;_&gt;</div>
<div class="tip" id="fs4">Multiple items<br />type Choice&lt;&#39;T1,&#39;T2&gt; =<br />&#160;&#160;| Choice1Of2 of &#39;T1<br />&#160;&#160;| Choice2Of2 of &#39;T2<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3&gt; =<br />&#160;&#160;| Choice1Of3 of &#39;T1<br />&#160;&#160;| Choice2Of3 of &#39;T2<br />&#160;&#160;| Choice3Of3 of &#39;T3<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4&gt; =<br />&#160;&#160;| Choice1Of4 of &#39;T1<br />&#160;&#160;| Choice2Of4 of &#39;T2<br />&#160;&#160;| Choice3Of4 of &#39;T3<br />&#160;&#160;| Choice4Of4 of &#39;T4<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5&gt; =<br />&#160;&#160;| Choice1Of5 of &#39;T1<br />&#160;&#160;| Choice2Of5 of &#39;T2<br />&#160;&#160;| Choice3Of5 of &#39;T3<br />&#160;&#160;| Choice4Of5 of &#39;T4<br />&#160;&#160;| Choice5Of5 of &#39;T5<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6&gt; =<br />&#160;&#160;| Choice1Of6 of &#39;T1<br />&#160;&#160;| Choice2Of6 of &#39;T2<br />&#160;&#160;| Choice3Of6 of &#39;T3<br />&#160;&#160;| Choice4Of6 of &#39;T4<br />&#160;&#160;| Choice5Of6 of &#39;T5<br />&#160;&#160;| Choice6Of6 of &#39;T6<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7&gt; =<br />&#160;&#160;| Choice1Of7 of &#39;T1<br />&#160;&#160;| Choice2Of7 of &#39;T2<br />&#160;&#160;| Choice3Of7 of &#39;T3<br />&#160;&#160;| Choice4Of7 of &#39;T4<br />&#160;&#160;| Choice5Of7 of &#39;T5<br />&#160;&#160;| Choice6Of7 of &#39;T6<br />&#160;&#160;| Choice7Of7 of &#39;T7<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_,_,_,_&gt;</div>
<div class="tip" id="fs5">Multiple items<br />val Failure : message:string -&gt; exn<br /><br />Full name: Microsoft.FSharp.Core.Operators.Failure<br /><br />--------------------<br />active recognizer Failure: exn -&gt; string option<br /><br />Full name: Microsoft.FSharp.Core.Operators.( |Failure|_| )</div>
<div class="tip" id="fs6">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs7">module String<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs8">val length : str:string -&gt; int<br /><br />Full name: Microsoft.FSharp.Core.String.length</div>
<div class="tip" id="fs9">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs10">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs11">val not : value:bool -&gt; bool<br /><br />Full name: Microsoft.FSharp.Core.Operators.not</div>
<div class="tip" id="fs12">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs13">val rev : list:&#39;T list -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.rev</div>

        <!-- Any section element inside of this container is displayed as a slide -->
        <div class="slides">
            <section >

<h2>パーザコンビネータをつくろう</h2>

<p>PEGと構文解析に関するアレコレの勉強会 Vol.1</p>

</section>

<section >

<h3>自己紹介</h3>

<p><img src="https://camo.githubusercontent.com/5dbd18d5fc15054677aaab64d647c4a076483af4/68747470733a2f2f646c2e64726f70626f7875736572636f6e74656e742e636f6d2f752f35373437383735382f7062736b2e6a7067" alt="icon" /></p>

<ul>
<li>なかやん・ゆーき / ぺんぎん / もみあげ</li>
<li><a href="https://twitter.com/pocketberserker">@pocketberserker</a></li>
<li>Microsoft MVP for <del>F#</del> .NET (2015/04/01～ 2016/03/31)</li>
<li>パーザコンビネータライブラリはてきとーにwatchしてる</li>
</ul>

</section>

<section >

<h3>パーザコンビネータ is 何</h3>

<p><a href="https://en.wikipedia.org/wiki/Parser_combinator">Wikipedia</a> 曰く</p>

<blockquote>
  <p>In functional programming, a parser combinator is a higher-order function that accepts several parsers as input and returns a new parser as its output.</p>
</blockquote>

<p>てきとー訳</p>

<blockquote>
  <p>関数プログラミングでは、パーザコンビネータは入力としていくつかのパーザを受け取り、出力として新しいパーザを返す高階関数です。</p>
</blockquote>

<p>なるほどね</p>

</section>

<section >

<h3>パーザコンビネータライブラリ</h3>

<ul>
<li><a href="https://github.com/aslatter/parsec">Parsec</a></li>
<li><a href="https://github.com/ekmett/trifecta">Trifecta</a></li>
<li><a href="https://github.com/scala/scala-parser-combinators">scala-parser-combinators</a></li>
<li><a href="https://github.com/Geal/nom">nom</a></li>
<li>Boost Spirit</li>
<li><a href="https://github.com/jneen/parsimmon">parsimmon</a></li>
</ul>

<p>他にもたくさん</p>

</section>

<section >

<h3>私とパーザコンビネータ</h3>

<ul>
<li><a href="https://github.com/pocketberserker/FsAttoparsec">FsAttoparsec</a> 作ってみたり</li>
<li><a href="https://github.com/bleis-tift/SmlSharpContrib">SmlSharpContrib</a> にそれっぽいもの作ってみたり</li>
<li><a href="https://github.com/tpolecat/atto">atto</a> に手を入れたり</li>
<li>仕事で Boost.Spirit 使ってみたり</li>
</ul>

</section>

<section >

<h3>ところで</h3>

<p>会場に</p>

<ul>
<li>パーザコンビネータ使ったことがある方</li>
<li>パーザコンビネータ実装したことがある方</li>
</ul>

<p>が多い場合、以降の発表内容を考える?</p>

</section>

<section >

<h3>パーザコンビネータの学び方</h3>

<p><a href="http://book.impress.co.jp/books/1114101091">FP in Scala</a> の第9章</p>

<p><img src="./images/fp-in-scala.png" alt="tweet" /></p>

</section>

<section >

<h3>どゆこと?</h3>

<ul>
<li>実装方法を知れば使い方もわかるよね、的な</li>
<li>というわけで、簡単なものを作ってみましょう</li>
<li><strong>F#</strong> で</li>
</ul>

</section>

<section >

<h3>解析を実行する関数の型を考える</h3>

<p>パーザと入力を受け取って解析結果を返せばよい…気がする</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">val</span> <span class="i">run</span><span class="o">:</span> <span class="i">Parser</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">string</span> <span class="k">-&gt;</span> <span class="i">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>

<ul>
<li>Parser: パーザ</li>
<li>Result: 解析結果</li>
<li><code>'T</code>は解析成功時に得られるデータ</li>
</ul>

<p>それっぽい</p>

</section>

<section >

<h3>Parser<'T> について考える</h3>

<ul>
<li>解析開始位置があれば解析できそう</li>
<li>何か操作をすれば <code>Result&lt;'T&gt;</code> を返そう</li>
</ul>

</section>

<section >

<h3>Parser<'T> の実態</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// なんかレコード</span>
<span class="k">type</span> <span class="i">State</span> <span class="o">=</span> {
  <span class="i">Input</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs1', 2)" onmouseover="showTip(event, 'fs1', 2)" class="i">string</span>
  <span class="i">Pos</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">int</span>
}
<span class="c">// 今回は単なる関数のtype alias</span>
<span class="k">type</span> <span class="i">Parser</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="i">State</span> <span class="k">-&gt;</span> <span class="i">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>

<p>実装次第では <code>pos</code> だけでいい</p>

</section>

<section >

<h3>Result<'T> その1</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// Haskell だと Maybe</span>
<span class="k">type</span> <span class="i">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">&#39;</span><span class="i">T</span> <span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="i">option</span>
</code></pre></td>
</tr>
</table>

<ul>
<li>要件は満たす</li>
<li>が、解析失敗時の情報が全くない</li>
<li>もうちょっと情報を増やそう</li>
</ul>

</section>

<section >

<h3>Result<'T> その2</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// Haskell だと Either</span>
<span class="k">type</span> <span class="i">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="i">Choice</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span>, <span onmouseout="hideTip(event, 'fs1', 6)" onmouseover="showTip(event, 'fs1', 6)" class="i">string</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>

<ul>
<li>成功時は <code>'T</code>、 失敗時は <code>string</code></li>
<li>よさげ</li>
<li>でも名前がわかりにくい</li>
<li>ちょっと定義し直し</li>
</ul>

</section>

<section >

<h3>Result<'T> その3</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="o">=</span>
| <span class="i">Success</span> <span class="k">of</span> <span class="o">&#39;</span><span class="i">T</span>
| <span onmouseout="hideTip(event, 'fs5', 7)" onmouseover="showTip(event, 'fs5', 7)" class="i">Failure</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs1', 8)" onmouseover="showTip(event, 'fs1', 8)" class="i">string</span>
</code></pre></td>
</tr>
</table>

<ul>
<li><code>string</code> ではなく <code>NonEmptyList[String]</code> とかのほうがいいけど今回は略</li>
<li>なんか足りない気がする</li>
</ul>

</section>

<section >

<h3>Result<'T> その4</h3>

<p>解析成功時のpositionがあったほうが合成しやすそう</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Result</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="o">=</span>
| <span class="i">Success</span> <span class="k">of</span> <span class="o">&#39;</span><span class="i">T</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs2', 9)" onmouseover="showTip(event, 'fs2', 9)" class="i">int</span>
| <span onmouseout="hideTip(event, 'fs5', 10)" onmouseover="showTip(event, 'fs5', 10)" class="i">Failure</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs1', 11)" onmouseover="showTip(event, 'fs1', 11)" class="i">string</span>
</code></pre></td>
</tr>
</table>

<p><code>'T * State</code> のほうがよさそうだけど今回は略</p>

</section>

<section >

<h3>run 関数実装</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">run</span> (<span class="i">parser</span><span class="o">:</span> <span class="i">Parser</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="i">input</span> <span class="o">=</span>
  <span class="k">let</span> <span class="i">init</span> <span class="o">=</span> { <span class="i">Input</span> <span class="o">=</span> <span class="i">input</span>; <span class="i">Pos</span> <span class="o">=</span> <span class="n">0</span> }
  <span class="i">parser</span> <span class="i">init</span>
</code></pre></td>
</tr>
</table>

</section>

<section >

<h3>実際にパーザを作る</h3>

<p>指針がほしいので、以下の二つを足がかりにする</p>

<ul>
<li>PEG</li>
<li>Parser Monad</li>
</ul>

<p>以降のスライドでは一部実装を省略します</p>

</section>

<section >

<h3>文字列リテラル(PEG)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">pstring</span> <span class="i">str</span> <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span>
  <span class="k">match</span> <span class="i">State</span><span class="o">.</span><span class="i">extract</span> <span class="i">s</span> <span class="k">with</span>
  <span class="c">// 入力の先頭に一致したら成功</span>
  | <span onmouseout="hideTip(event, 'fs6', 12)" onmouseover="showTip(event, 'fs6', 12)" class="i">Some</span> <span class="i">target</span> <span class="k">when</span> <span class="i">target</span><span class="o">.</span><span class="i">StartsWith</span>(<span class="i">str</span>) <span class="k">-&gt;</span> <span class="i">Success</span>(<span class="i">str</span>, <span class="i">s</span><span class="o">.</span><span class="i">Pos</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs7', 13)" onmouseover="showTip(event, 'fs7', 13)" class="i">String</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 14)" onmouseover="showTip(event, 'fs8', 14)" class="i">length</span> <span class="i">str</span>)
  | <span onmouseout="hideTip(event, 'fs6', 15)" onmouseover="showTip(event, 'fs6', 15)" class="i">Some</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs5', 16)" onmouseover="showTip(event, 'fs5', 16)" class="i">Failure</span> (<span onmouseout="hideTip(event, 'fs9', 17)" onmouseover="showTip(event, 'fs9', 17)" class="i">sprintf</span> <span class="s">&quot;文字列\&quot;%s\&quot;にマッチしませんでした&quot;</span> <span class="i">str</span>)
  | <span onmouseout="hideTip(event, 'fs10', 18)" onmouseover="showTip(event, 'fs10', 18)" class="i">None</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs5', 19)" onmouseover="showTip(event, 'fs5', 19)" class="i">Failure</span> <span class="s">&quot;pstring: もう入力がないよ&quot;</span>
</code></pre></td>
</tr>
</table>

</section>

<section >

<h3>ワイルドカード(PEG)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// 位置文字あればよい</span>
<span class="k">let</span> <span class="i">any</span> <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span>
  <span class="k">match</span> <span class="i">State</span><span class="o">.</span><span class="i">extract</span> <span class="i">s</span> <span class="k">with</span>
  | <span onmouseout="hideTip(event, 'fs6', 20)" onmouseover="showTip(event, 'fs6', 20)" class="i">Some</span> <span class="i">target</span> <span class="k">when</span> <span onmouseout="hideTip(event, 'fs11', 21)" onmouseover="showTip(event, 'fs11', 21)" class="i">not</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs7', 22)" onmouseover="showTip(event, 'fs7', 22)" class="i">String</span><span class="o">.</span><span class="i">IsNullOrEmpty</span>(<span class="i">target</span>) <span class="k">-&gt;</span> <span class="i">Success</span>(<span class="i">target</span><span class="o">.</span><span class="i">Chars</span>(<span class="n">0</span>), <span class="i">s</span><span class="o">.</span><span class="i">Pos</span> <span class="o">+</span> <span class="n">1</span>)
  | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs5', 23)" onmouseover="showTip(event, 'fs5', 23)" class="i">Failure</span> <span class="s">&quot;any: もう入力がないよ&quot;</span>
</code></pre></td>
</tr>
</table>

</section>

<section >

<h3>連接(PEG)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">andThen</span> <span class="i">a</span> <span class="i">b</span> <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span>
  <span class="i">a</span> <span class="i">s</span>
  <span class="o">|&gt;</span> <span class="i">Result</span><span class="o">.</span><span class="i">bind</span> (<span class="k">fun</span> <span class="i">r1</span> <span class="i">rpos1</span> <span class="k">-&gt;</span>
    <span class="c">// 一つ目の解析に成功したらpositionを更新し</span>
    <span class="i">State</span><span class="o">.</span><span class="i">update</span> <span class="i">rpos1</span> <span class="i">s</span>
    <span class="o">|&gt;</span> <span class="i">b</span>
    <span class="c">// 二つめの解析を試みる</span>
    <span class="o">|&gt;</span> <span class="i">Result</span><span class="o">.</span><span class="i">map</span> (<span class="k">fun</span> <span class="i">r2</span> <span class="i">rpos2</span> <span class="k">-&gt;</span> ((<span class="i">r1</span>, <span class="i">r2</span>), <span class="i">rpos2</span>)))
</code></pre></td>
</tr>
</table>

<p>両方に成功しないと成功とみなさない</p>

</section>

<section >

<h3>選択(PEG)</h3>

<p>a に失敗したら b で解析を試みる</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> (<span class="o">&lt;/&gt;</span>) <span class="i">a</span> <span class="i">b</span> <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span>
  <span class="k">match</span> <span class="i">a</span> <span class="i">s</span> <span class="k">with</span>
  | <span class="i">Success</span> _ <span class="k">as</span> <span class="i">p</span> <span class="k">-&gt;</span> <span class="i">p</span>
  | _ <span class="k">-&gt;</span> <span class="i">b</span> <span class="i">s</span>
</code></pre></td>
</tr>
</table>

</section>

<section >

<h3>繰り返し(PEG)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">many</span> <span class="i">p</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="i">inner</span> <span class="i">acc</span> <span class="i">s</span> <span class="o">=</span>
    <span class="k">match</span> <span class="i">p</span> <span class="i">s</span> <span class="k">with</span>
    | <span class="i">Success</span>(<span class="i">v</span>, <span class="i">rpos1</span>) <span class="k">-&gt;</span> <span class="i">inner</span> (<span class="i">v</span> <span class="o">::</span> <span class="i">acc</span>) (<span class="i">State</span><span class="o">.</span><span class="i">update</span> <span class="i">rpos1</span> <span class="i">s</span>)
    | <span onmouseout="hideTip(event, 'fs5', 24)" onmouseover="showTip(event, 'fs5', 24)" class="i">Failure</span> _ <span class="k">-&gt;</span> <span class="i">Success</span>(<span onmouseout="hideTip(event, 'fs12', 25)" onmouseover="showTip(event, 'fs12', 25)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 26)" onmouseover="showTip(event, 'fs13', 26)" class="i">rev</span> <span class="i">acc</span>, <span class="i">s</span><span class="o">.</span><span class="i">Pos</span>)
  <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span> <span class="i">inner</span> [] <span class="i">s</span>
</code></pre></td>
</tr>
</table>

<ul>
<li>失敗するまでひたすらpositionを更新しながら解析</li>
<li><code>many1</code> は <code>andThen</code> と List.cons を使えばよい</li>
</ul>

</section>

<section >

<h3>否定先読み(PEG)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">bang</span> <span class="i">p</span> <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span>
  <span class="k">match</span> <span class="i">p</span> <span class="i">s</span> <span class="k">with</span>
  | <span class="i">Success</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs5', 27)" onmouseover="showTip(event, 'fs5', 27)" class="i">Failure</span> <span class="s">&quot;bang&quot;</span>
  | <span onmouseout="hideTip(event, 'fs5', 28)" onmouseover="showTip(event, 'fs5', 28)" class="i">Failure</span> _ <span class="k">-&gt;</span> <span class="i">Success</span>((), <span class="i">s</span><span class="o">.</span><span class="i">Pos</span>)
</code></pre></td>
</tr>
</table>

</section>

<section >

<h3>ok関数(Monad, return の代わり)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">ok</span> <span class="i">value</span> <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span> <span class="i">Success</span>(<span class="i">value</span>, <span class="i">s</span><span class="o">.</span><span class="i">Pos</span>)
</code></pre></td>
</tr>
</table>

<p>パーザ内で条件分岐させた後にパーザを返したりするときに便利</p>

</section>

<section >

<h3>bind関数(Monad)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">bind</span> <span class="i">f</span> <span class="i">p</span> <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span>
  <span class="k">match</span> <span class="i">p</span> <span class="i">s</span> <span class="k">with</span>
  | <span class="i">Success</span>(<span class="i">value</span>, <span class="i">pos</span>) <span class="k">-&gt;</span> <span class="i">s</span> <span class="o">|&gt;</span> <span class="i">State</span><span class="o">.</span><span class="i">update</span> <span class="i">pos</span> <span class="o">|&gt;</span> <span class="i">f</span> <span class="i">value</span>
  | <span onmouseout="hideTip(event, 'fs5', 29)" onmouseover="showTip(event, 'fs5', 29)" class="i">Failure</span> <span class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs5', 30)" onmouseover="showTip(event, 'fs5', 30)" class="i">Failure</span> <span class="i">r</span>
</code></pre></td>
</tr>
</table>

</section>

<section >

<h3>map関数(Functor)</h3>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">map</span> <span class="i">f</span> (<span class="i">p</span><span class="o">:</span> <span class="i">Parser</span><span class="o">&lt;</span>_<span class="o">&gt;</span>) <span class="o">=</span> <span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span>
  <span class="k">match</span> <span class="i">p</span> <span class="i">s</span> <span class="k">with</span>
  | <span class="i">Success</span>(<span class="i">value</span>, <span class="i">pos</span>) <span class="k">-&gt;</span> <span class="i">Success</span>(<span class="i">f</span> <span class="i">value</span>, <span class="i">pos</span>)
  | <span onmouseout="hideTip(event, 'fs5', 31)" onmouseover="showTip(event, 'fs5', 31)" class="i">Failure</span> <span class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs5', 32)" onmouseover="showTip(event, 'fs5', 32)" class="i">Failure</span> <span class="i">r</span>
</code></pre></td>
</tr>
</table>

<p>解析結果を変換したいよね？</p>

</section>

<section >

<h3>まとめ</h3>

<ul>
<li>パーザコンビネータの仕組み自体は簡単、こわくない</li>
<li>実際はパフォーマンスチューニングのためにもっと色々やってるけど</li>
<li>実際はエラー出力のために(ry</li>
<li>構文解析楽しく学ぼう</li>
</ul>

</section>



        </div>
    </div>
    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>
    <script>
        // Add the nohighlight class and data-noescape attribute to code elements that have already been formatted by FSharp.Formatting
        $('pre.highlighted code').addClass('nohighlight').attr('data-noescape', '');

        // Full list of configuration options available here:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: true,
            progress: true,
            history: true,
            center: true,

            transition: 'default', // default/cube/page/concave/zoom/linear/fade/none

            // Parallax scrolling
            // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
            // parallaxBackgroundSize: '2100px 900px',

            // Optional libraries used to extend on reveal.js
            dependencies: [
                { src: 'lib/js/classList.js', condition: function () { return !document.body.classList; } },
                { src: 'plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
                { src: 'plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
                { src: 'plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } },
                { src: 'plugin/zoom-js/zoom.js', async: true, condition: function () { return !!document.body.classList; } },
                { src: 'plugin/notes/notes.js', async: true, condition: function () { return !!document.body.classList; } }
            ]
        });

    </script>
</body>
</html>

